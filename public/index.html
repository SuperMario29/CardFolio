<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CardFolio</title>
    <style>
        :root {
            --primary: #512BD4;
            --primary-dark: #2b0a75;
            --secondary: #0366d6;
            --background: #f8f9fa;
            --surface: #ffffff;
            --text-main: #333333;
            --text-light: #666666;
            --border: #d0d0d0; 
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --radius: 8px;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', Inter, system-ui, sans-serif; }
        body { margin: 0; background-color: var(--background); color: var(--text-main); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        h1, h2, h3 { margin: 0 0 1rem 0; font-weight: 600; }
        p { margin: 0 0 0.5rem 0; color: var(--text-light); }
        .text-sm { font-size: 0.875rem; }
        .text-muted { color: var(--text-light); }

        button { cursor: pointer; border: none; padding: 0.5rem 1rem; border-radius: var(--radius); font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background-color: var(--primary); color: white; }
        .btn-primary:hover { background-color: var(--primary-dark); }
        .btn-secondary { background-color: white; border: 1px solid var(--border); color: var(--text-main); }
        .btn-secondary:hover { background-color: #f1f1f1; }
        .btn-danger { background-color: var(--danger); color: white; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.8rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        input, select, textarea { 
            padding: 0.75rem; 
            border: 1px solid var(--border); 
            border-radius: var(--radius); 
            width: 100%; 
            margin-bottom: 1rem; 
            background-color: #ffffff;
            color: #000000; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
            font-size: 1rem;
        }
        textarea { resize: vertical; min-height: 80px; }
        input:focus, select:focus, textarea:focus { 
            outline: 2px solid var(--primary); 
            border-color: transparent; 
            box-shadow: 0 0 0 3px rgba(0,0,0,0.1); 
        }
        label { display: block; margin-bottom: 0.25rem; font-size: 0.9rem; font-weight: 600; color: var(--text-main); }
        
        .form-section { border-top: 1px solid var(--border); margin-top: 1rem; padding-top: 1rem; }
        .form-section h4 { font-size: 0.95rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.8rem; }

        #app { display: flex; height: 100%; width: 100%; }
        
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        .login-card {
            background: var(--surface); padding: 2.5rem; border-radius: var(--radius);
            width: 100%; max-width: 420px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            position: relative; overflow: hidden; text-align: center;
        }

        .app-logo { 
            width: 80px; height: 80px; 
            object-fit: cover; 
            border-radius: 50%; 
            border: 3px solid var(--primary);
            background-color: #f0f0f0;
            margin-bottom: 1rem;
        }
        .sidebar-logo {
            width: 32px; height: 32px;
            object-fit: cover;
            border-radius: 4px;
            background-color: #eee;
        }

        .d-none { display: none !important; }
        .d-block { display: block; }

        .sidebar {
            width: 260px; background-color: #1e1e2f; color: white; display: flex; flex-direction: column;
            flex-shrink: 0; transition: width 0.3s;
        }
        .sidebar-header { padding: 1.5rem; font-size: 1.2rem; font-weight: bold; border-bottom: 1px solid #333; display: flex; align-items: center; gap: 15px; }
        .nav-links { flex: 1; padding: 1rem 0; overflow-y: auto; }
        .nav-item {
            padding: 0.8rem 1.5rem; color: #a0a0a0; text-decoration: none; display: flex; align-items: center; gap: 10px;
            cursor: pointer;
        }
        .nav-item:hover, .nav-item.active { background-color: var(--primary); color: white; }
        .user-info { padding: 1rem; border-top: 1px solid #333; font-size: 0.9rem; }
        
        .main-content { flex: 1; overflow-y: auto; padding: 2rem; background-color: var(--background); display: flex; flex-direction: column; }
        
        .card { background: var(--surface); padding: 1.5rem; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }
        .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
        .grid-4 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 1200px; /* Increased for new columns */ }
        th, td { text-align: left; padding: 0.75rem; border-bottom: 1px solid var(--border); font-size: 0.85rem; }
        th { background-color: #f8f9fa; color: var(--text-light); font-weight: 600; white-space: nowrap; }
        tr:hover { background-color: #f1f1f1; }
        
        .desc-cell {
            max-width: 200px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            color: var(--text-light); 
            font-style: italic;
        }

        .badge { padding: 0.25rem 0.5rem; border-radius: 99px; font-size: 0.75rem; font-weight: 600; display: inline-block; }
        .badge-admin { background-color: var(--danger); color: white; }
        .badge-super { background-color: var(--primary); color: white; }
        .badge-employee { background-color: var(--success); color: white; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--surface); width: 600px; max-width: 95%; max-height: 90vh; overflow-y: auto; border-radius: var(--radius); padding: 2rem; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-footer { margin-top: 1.5rem; display: flex; justify-content: flex-end; gap: 0.5rem; }

        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; }
        .toast {
            background: #333; color: white; padding: 1rem 1.5rem; border-radius: var(--radius);
            margin-top: 0.5rem; opacity: 0; transform: translateY(20px); transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .toast.show { opacity: 1; transform: translateY(0); }

        .bar-chart { display: flex; flex-direction: column; gap: 15px; }
        .bar-row { display: flex; align-items: center; gap: 10px; }
        .bar-label { width: 150px; font-size: 0.9rem; text-align: right; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .bar-track { flex: 1; background: #e9ecef; height: 24px; border-radius: 12px; overflow: hidden; position: relative; }
        .bar-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.8s ease-out; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; color: white; font-size: 0.8rem; font-weight: bold; }

        @media (max-width: 768px) {
            .sidebar { position: fixed; left: -260px; height: 100%; z-index: 1000; width: 260px; }
            .sidebar.open { left: 0; }
            .main-content { padding: 1rem; }
            .mobile-menu-btn { display: block; margin-right: 1rem; cursor: pointer; }
            .grid-2 { grid-template-columns: 1fr; }
            .bar-label { width: 100px; }
            .grid-4 { grid-template-columns: 1fr; }
        }
        @media (min-width: 769px) { .mobile-menu-btn { display: none; } }

        .hidden { display: none !important; }
        .flex-between { display: flex; justify-content: space-between; align-items: center; }
        .otp-input { font-size: 1.5rem; letter-spacing: 0.5rem; text-align: center; }
        
        .logo-preview-box {
            border: 2px dashed var(--border);
            padding: 10px;
            border-radius: var(--radius);
            display: flex;
            justify-content: center;
            align-items: center;
            height: 80px;
            background: #f9f9f9;
        }

        input[type="color"] {
            -webkit-appearance: none;
            border: none;
            width: 50px;
            height: 50px;
            padding: 0;
            cursor: pointer;
            margin: 0;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0; 
        }
        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: 50%;
            border:1px solid #ddd;
        }
        
        /* Cost Cell Styling */
        .cost-cell { font-family: 'Courier New', monospace; color: var(--text-main); font-weight: 600; }
        .cost-formula { font-size: 0.7rem; color: var(--text-light); display: block; margin-top: 2px; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div id="login-screen">
        <div class="login-card">
            <img id="login-logo" src="" alt="Logo" class="app-logo" style="display: none;">
            <h2 style="text-align: center; color: white; margin-bottom: 0.5rem;" id="login-title">CardFolio</h2>
            <p style="text-align: center; color: rgba(255,255,255,0.8);">Management System</p>

            <div id="login-step-1">
                <form id="login-form">
                    <label style="color: #333;">Username / Email</label>
                    <input type="text" id="login-email" placeholder="admin@test.com" required>
                    <label style="color: #333;">Password</label>
                    <input type="password" id="login-password" placeholder="******" required>
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Next: Verify Identity</button>
                </form>
            </div>

            <div id="login-step-2" class="d-none">
                <h2 style="text-align: center; color: white;">Two-Factor Auth</h2>
                <p style="text-align: center; color: rgba(255,255,255,0.8);">A code has been sent to your email.</p>
                <div style="background: #ffffff; padding: 15px; border-radius: 8px; border: 1px solid #b3e5fc; margin-bottom: 20px;">
                    <strong style="color: #333;">Demo Mode:</strong> Check Toast or Console for your code.
                </div>
                <form id="otp-form">
                    <input type="hidden" id="otp-email">
                    <label style="color: #333;">Enter 6-Digit Code</label>
                    <input type="text" id="otp-code" class="otp-input" placeholder="000000" maxlength="6" required pattern="\d{6}">
                    <button type="submit" class="btn-primary" style="width: 100%; margin-top: 1rem;">Verify & Login</button>
                </form>
                <div style="text-align: center; margin-top: 10px;">
                    <button type="button" onclick="auth.resetLogin()" class="btn-sm btn-secondary">Back</button>
                </div>
            </div>
        </div>
    </div>

    <div id="app-shell" class="hidden" style="display: flex; width: 100%; height: 100%;">
        
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <img id="app-logo" src="" alt="Logo" class="sidebar-logo">
                <span id="app-name-display">CardFolio</span>
            </div>
            <div class="nav-links">
                <a class="nav-item active" onclick="router.navigate('dashboard')"><span>üìä</span> Dashboard</a>
                <a class="nav-item" onclick="router.navigate('inventory')"><span>üì¶</span> Inventory</a>
                <a class="nav-item" onclick="router.navigate('reports')"><span>üìà</span> Reports</a>
                <div style="height: 1px; background: #333; margin: 10px 0;"></div>
                <a class="nav-item hidden" id="nav-cats" onclick="router.navigate('categories')"><span>üè∑Ô∏è</span> Categories</a>
                <a class="nav-item hidden" id="nav-users" onclick="router.navigate('users')"><span>üë•</span> Users</a>
                <a class="nav-item hidden" id="nav-config" onclick="router.navigate('config')"><span>‚öôÔ∏è</span> Configuration</a>
            </div>
            <div class="user-info">
                <div id="user-display-name" style="font-weight: bold;">User</div>
                <div id="user-display-role" class="text-sm text-muted">Role</div>
                <button onclick="auth.logout()" class="btn-sm btn-secondary" style="margin-top: 0.5rem; width: 100%;">Sign Out</button>
            </div>
        </nav>

        <main class="main-content">
            <header class="flex-between" style="margin-bottom: 2rem;">
                <div class="flex-between">
                    <div class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</div>
                    <h2 id="page-title">Dashboard</h2>
                </div>
                <div id="action-area"></div>
            </header>

            <!-- VIEW: DASHBOARD -->
            <section id="view-dashboard" class="view">
                <div class="grid-3">
                    <div class="card"><p>Total SKUs</p><h1 id="stat-skus">0</h1></div>
                    <div class="card"><p>Total Inventory Value</p><h1 id="stat-value">$0.00</h1></div>
                    <div class="card"><p>Low Stock Alerts</p><h1 id="stat-low" style="color: var(--danger);">0</h1></div>
                </div>
                <div class="card">
                    <h3>Recent Activity</h3>
                    <div class="table-container">
                        <table id="dashboard-recent-table">
                            <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Item</th></tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: INVENTORY -->
            <section id="view-inventory" class="view hidden">
                <div class="card">
                    <div class="flex-between" style="margin-bottom: 1rem; gap: 10px; flex-wrap: wrap;">
                        <div style="display:flex; gap: 10px; flex: 1; min-width: 200px;">
                            <input type="text" id="inventory-search" placeholder="Search SKU or Name..." style="margin-bottom: 0;">
                            <select id="inventory-cat-filter" style="max-width: 200px; margin-bottom: 0;"><option value="all">All Categories</option></select>
                        </div>
                        <button id="btn-add-item" class="btn-primary hidden" onclick="inventory.openAddModal()">+ Add New Item</button>
                    </div>
                    <div class="table-container">
                        <table id="inventory-table">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Category</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Price</th>
                                    <th>Stock (C/B/U)</th>
                                    <th>Total Units</th>
                                    <th>Unit Cost</th>
                                    <th>Box Cost</th>
                                    <th>Case Cost</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- VIEW: REPORTS -->
            <section id="view-reports" class="view hidden">
                <div class="grid-2">
                    <div class="card"><h3>Value by Category</h3><div id="report-value-chart" class="bar-chart"></div></div>
                    <div class="card"><h3>Low Stock Items (Below Threshold)</h3><div class="table-container"><table id="report-low-stock-table"><thead><tr><th>SKU</th><th>Name</th><th>Stock</th><th>Status</th></tr></thead><tbody></tbody></table></div></div>
                </div>
                <div class="card"><h3>Inventory Health Summary</h3><p>Total number of unique items vs active categories.</p><div style="display: flex; gap: 20px; margin-top: 10px;"><div><strong>Total Categories:</strong> <span id="report-total-cats">0</span></div><div><strong>Active SKUs:</strong> <span id="report-total-skus">0</span></div></div></div>
            </section>

            <!-- VIEW: CATEGORIES -->
            <section id="view-categories" class="view hidden">
                <div class="card">
                    <div class="flex-between" style="margin-bottom: 1rem;"><h3>Manage Categories</h3><button class="btn-primary" onclick="categories.openAddModal()">+ Add Category</button></div>
                    <div class="table-container"><table id="categories-table"><thead><tr><th>ID</th><th>Name</th><th>Item Count</th><th>Actions</th></tr></thead><tbody></tbody></table></div>
                </div>
            </section>

            <!-- VIEW: CONFIG -->
            <section id="view-config" class="view hidden">
                <div class="card" style="max-width: 700px;">
                    <h3>System Configuration</h3>
                    <div class="form-section">
                        <h4>Branding & Appearance</h4>
                        <div style="display: flex; gap: 20px; align-items: flex-start; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 200px;">
                                <label>Logo Image URL</label>
                                <input type="text" id="conf-logo-url" placeholder="https://example.com/logo.png">
                                <p class="text-sm text-muted">Paste a URL to a square image (JPG/PNG).</p>
                            </div>
                            <div style="width: 100px; text-align: center;" class="logo-preview-box">
                                <img id="logo-preview" src="" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                            </div>
                            <div style="flex: 0 0 auto; text-align: center;">
                                <label>Theme Color</label>
                                <input type="color" id="conf-theme-color" value="#512BD4">
                                <p class="text-sm text-muted">Click to change color</p>
                            </div>
                        </div>
                    </div>
                    <div class="form-section">
                        <h4>General Settings</h4>
                        <label>System Name</label>
                        <input type="text" id="conf-sys-name" required>
                        <label>Low Stock Threshold (Units)</label>
                        <input type="number" id="conf-low-stock" required>
                        <button type="submit" id="btn-save-config" class="btn-primary" style="margin-top: 1rem;">Save Configuration</button>
                    </div>
                </div>
            </section>

            <!-- VIEW: HISTORY -->
            <section id="view-history" class="view hidden">
                <div class="card"><div class="table-container"><table id="history-table"><thead><tr><th>Timestamp</th><th>User</th><th>Role</th><th>Action</th><th>Details</th></tr></thead><tbody></tbody></table></div></div>
            </section>

            <!-- VIEW: USERS -->
            <section id="view-users" class="view hidden">
                <div class="card"><div class="flex-between" style="margin-bottom: 1rem;"><h3>User Management</h3><button class="btn-primary" onclick="users.openAddModal()">+ Add User</button></div><div class="table-container"><table id="users-table"><thead><tr><th>Email</th><th>Role</th><th>Created</th><th>Actions</th></tr></thead><tbody></tbody></table></div></div>
            </section>

        </main>
    </div>

    <!-- MODALS -->
    
    <div id="modal-inventory" class="modal-overlay">
        <div class="modal">
            <div class="modal-header"><h3 id="inv-modal-title">Inbound Receiving</h3><button class="btn-sm btn-secondary" onclick="closeModals()">X</button></div>
            <form id="inv-form">
                <input type="hidden" id="inv-id">
                <h4>Product Information</h4>
                <div class="grid-4">
                    <div><label>SKU</label><input type="text" id="inv-sku" required></div>
                    <div><label>Category</label><select id="inv-category" required></select></div>
                    <div style="grid-column: span 2;"><label>Product Name</label><input type="text" id="inv-name" required></div>
                </div>
                <!-- NEW: DESCRIPTION FIELD -->
                <div style="grid-column: span 4;">
                    <label>Description</label>
                    <textarea id="inv-description" placeholder="Item details, condition, set contents..."></textarea>
                </div>
                <div class="form-section"><h4>Stock Configuration</h4><div class="grid-4"><div><label>Units per Box</label><input type="number" id="inv-units-per-box" value="10" min="1"></div><div><label>Boxes per Case</label><input type="number" id="inv-boxes-per-case" value="5" min="1"></div><div><label>Unit Price (Retail)</label><input type="number" step="0.01" id="inv-price" required></div><div><label>Total Units Received</label><input type="number" id="inv-units" required min="1"></div></div></div>
                <div class="form-section"><h4>Receiving Details</h4><div class="grid-4"><div><label>Inbound Type</label><select id="inv-inbound-type"><option value="Purchase Order">Purchase Order</option><option value="Return">Return</option><option value="Transfer">Transfer</option><option value="Consignment">Consignment</option></select></div><div><label>Supplier</label><input type="text" id="inv-supplier"></div><div><label>Carrier</label><input type="text" id="inv-carrier"></div><div><label>Tracking #</label><input type="text" id="inv-tracking"></div><div><label>Unit Type Received</label><select id="inv-unit-type-rcv"><option value="Units">Individual Units</option><option value="Boxes">Boxes</option><option value="Cases">Cases</option></select></div></div></div>
                <div class="form-section"><h4>Financials</h4><div class="grid-4"><div style="grid-column: span 2;"><label>Total Invoice Cost</label><input type="number" step="0.01" id="inv-invoice-cost"></div><div style="grid-column: span 2;"><p class="text-sm text-muted" style="margin-top: 10px;">Unit Cost will be calculated: <br><strong>Invoice Cost / Total Units</strong></p></div></div></div>
                <div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeModals()">Cancel</button><button type="submit" class="btn-primary">Save Item</button></div>
            </form>
        </div>
    </div>

    <div id="modal-stock" class="modal-overlay">
        <div class="modal"><div class="modal-header"><h3>Adjust Stock Level</h3><button class="btn-sm btn-secondary" onclick="closeModals()">X</button></div><form id="stock-form"><input type="hidden" id="stock-inv-id"><p>Adjusting stock for: <strong id="stock-item-name"></strong></p><label>Current Total Units: <span id="stock-current-units"></span></label><label>Adjustment Amount (+ or -)</label><input type="number" id="stock-amount" required><label>Reason</label><select id="stock-reason"><option value="Restock">Restock</option><option value="Sale">Sale</option><option value="Damage">Damage</option><option value="Loss">Loss</option></select><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeModals()">Cancel</button><button type="submit" class="btn-primary">Confirm Adjustment</button></div></form></div>
    </div>

    <div id="modal-category" class="modal-overlay">
        <div class="modal"><div class="modal-header"><h3>Add Category</h3><button class="btn-sm btn-secondary" onclick="closeModals()">X</button></div><form id="cat-form"><label>Category Name</label><input type="text" id="cat-name" required><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeModals()">Cancel</button><button type="submit" class="btn-primary">Create Category</button></div></form></div>
    </div>

    <div id="modal-user" class="modal-overlay">
        <div class="modal"><div class="modal-header"><h3>Add New User</h3><button class="btn-sm btn-secondary" onclick="closeModals()">X</button></div><form id="user-form"><label>Email Address</label><input type="email" id="user-email" required><label>Password</label><input type="password" id="user-pass" required><label>Role</label><select id="user-role"><option value="Employee">Employee</option><option value="SuperUser">Super User</option><option value="Admin">Admin</option></select><div class="modal-footer"><button type="button" class="btn-secondary" onclick="closeModals()">Cancel</button><button type="submit" class="btn-primary">Create User</button></div></form></div>
    </div>

    <script>
        const Utils = {
            id: () => Math.random().toString(36).substr(2, 9),
            formatCurrency: (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num),
            formatDate: (iso) => new Date(iso).toLocaleString(),
            darkenColor: (color, percent) => {
                let R = parseInt(color.substring(1,3),16);
                let G = parseInt(color.substring(3,5),16);
                let B = parseInt(color.substring(5,7),16);
                R = parseInt(R * (100 - percent) / 100);
                G = parseInt(G * (100 - percent) / 100);
                B = parseInt(B * (100 - percent) / 100);
                R = (R<255)?R:255;G = (G<255)?G:255;B = (B<255)?B:255;
                const RR = ((R.toString(16).length==1)?"0"+R.toString(16):R.toString(16));
                const GG = ((G.toString(16).length==1)?"0"+G.toString(16):G.toString(16));
                const BB = ((B.toString(16).length==1)?"0"+B.toString(16):B.toString(16));
                return "#"+RR+GG+BB;
            }
        };

        const API = {
            async get(endpoint) {
                const res = await fetch(`/api/${endpoint}`);
                if (!res.ok) throw new Error('API Error');
                return await res.json();
            },
            async post(endpoint, data) {
                const res = await fetch(`/api/${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!res.ok) throw new Error('API Error');
                return await res.json();
            },
            async delete(endpoint) {
                const res = await fetch(`/api/${endpoint}`, { method: 'DELETE' });
                if (!res.ok) throw new Error('API Error');
                return await res.json();
            }
        };

        const auth = {
            user: null,
            pendingEmail: null, 
            
            async login(email, password) {
                try {
                    const res = await API.post('login', { email, password });
                    if (res.requires2FA) {
                        this.pendingEmail = email;
                        if (res.simulatedCode) {
                            ui.toast(`Simulated Email Sent! Code: ${res.simulatedCode}`, 'info', 8000);
                        }
                        this.showStep2();
                        return false; 
                    } else if (res.user) {
                        this.user = res.user;
                        sessionStorage.setItem('cims_session', JSON.stringify(this.user));
                        return true;
                    }
                } catch(e) {
                    return false;
                }
            },

            async verifyOtp(code) {
                try {
                    const res = await API.post('verify-otp', { email: this.pendingEmail, code: code });
                    if (res.user) {
                        this.user = res.user;
                        sessionStorage.setItem('cims_session', JSON.stringify(this.user));
                        this.pendingEmail = null;
                        return true;
                    }
                } catch(e) {
                    return false;
                }
                return false;
            },

            showStep2() {
                document.getElementById('login-step-1').classList.add('d-none');
                document.getElementById('login-step-2').classList.remove('d-none');
                document.getElementById('otp-email').value = this.pendingEmail;
                document.getElementById('otp-code').focus();
            },

            resetLogin() {
                document.getElementById('login-step-2').classList.add('d-none');
                document.getElementById('login-step-1').classList.remove('d-none');
                document.getElementById('login-form').reset();
                document.getElementById('otp-form').reset();
                this.pendingEmail = null;
            },

            checkSession() {
                const session = sessionStorage.getItem('cims_session');
                if (session) {
                    this.user = JSON.parse(session);
                    return true;
                }
                return false;
            },
            logout() {
                this.user = null;
                sessionStorage.removeItem('cims_session');
                this.resetLogin();
                router.showLogin();
            },
            canEdit(screen) {
                if (!this.user) return false;
                if (this.user.role === 'Admin') return true;
                if (this.user.role === 'SuperUser' && (screen === 'inventory' || screen === 'categories')) return true;
                if (this.user.role === 'Employee' && screen === 'stock') return true;
                return false;
            }
        };

        const router = {
            async navigate(view) {
                if (view === 'users' && auth.user.role !== 'Admin') { ui.toast('Access Denied', 'error'); return; }
                if (view === 'config' && auth.user.role !== 'Admin') { ui.toast('Access Denied', 'error'); return; }
                if (view === 'categories' && auth.user.role === 'Employee') { ui.toast('Access Denied', 'error'); return; }

                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navLink = document.querySelector(`.nav-item[onclick*="'${view}'"]`);
                if(navLink) navLink.classList.add('active');

                document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
                document.getElementById(`view-${view}`).classList.remove('hidden');

                const titles = { 'dashboard': 'Dashboard', 'inventory': 'Inventory Management', 'reports': 'System Reports', 'categories': 'Category Management', 'config': 'System Configuration', 'history': 'Change History', 'users': 'User Accounts' };
                document.getElementById('page-title').innerText = titles[view];
                
                if(view === 'dashboard') await ui.renderDashboard();
                if(view === 'inventory') await ui.renderInventory();
                if(view === 'history') await ui.renderHistory();
                if(view === 'users') await ui.renderUsers();
                if(view === 'categories') await ui.renderCategories();
                if(view === 'config') await ui.renderConfig();
                if(view === 'reports') await ui.renderReports();

                if(window.innerWidth <= 768) toggleSidebar();
            },
            async init() {
                if (auth.checkSession()) {
                    this.showApp();
                } else {
                    this.showLogin();
                }
            },
            showLogin() {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('app-shell').classList.add('hidden');
                this.loadBasicConfig();
            },
            async loadBasicConfig() {
                try {
                    const conf = await API.get('config');
                    this.applyBranding(conf);
                } catch(e) { console.log('Config not loaded yet'); }
            },
            async showApp() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('app-shell').classList.remove('hidden');
                document.getElementById('app-shell').style.display = 'flex'; 
                const conf = await API.get('config');
                this.applyBranding(conf);
                
                document.getElementById('user-display-name').innerText = auth.user.email;
                document.getElementById('user-display-role').innerText = auth.user.role;
                const role = auth.user.role;
                document.getElementById('nav-users').classList.toggle('hidden', role !== 'Admin');
                document.getElementById('nav-config').classList.toggle('hidden', role !== 'Admin');
                document.getElementById('nav-cats').classList.toggle('hidden', role === 'Employee');
                this.navigate('dashboard');
            },
            applyBranding(conf) {
                document.getElementById('app-name-display').innerText = conf.system_name || 'CardFolio';
                
                const logoUrl = conf.logo_url;
                const appLogo = document.getElementById('app-logo');
                const loginLogo = document.getElementById('login-logo');
                const title = document.getElementById('login-title');

                if (logoUrl) {
                    appLogo.src = logoUrl;
                    loginLogo.src = logoUrl;
                    loginLogo.style.display = 'block';
                    title.style.display = 'none'; 
                } else {
                    appLogo.src = ''; 
                    loginLogo.src = ''; 
                    loginLogo.style.display = 'none'; 
                    title.style.display = 'block';
                }

                if (conf.theme_color) {
                    const primary = conf.theme_color;
                    const dark = Utils.darkenColor(primary, 20);
                    document.documentElement.style.setProperty('--primary', primary);
                    document.documentElement.style.setProperty('--primary-dark', dark);
                } else {
                    document.documentElement.style.setProperty('--primary', '#512BD4');
                    document.documentElement.style.setProperty('--primary-dark', '#2b0a75');
                }
            }
        };

        const ui = {
            toast(msg, type = 'success', duration = 3000) {
                const container = document.getElementById('toast-container');
                const el = document.createElement('div');
                el.className = `toast toast-${type}`;
                el.innerText = msg;
                container.appendChild(el);
                void el.offsetWidth; 
                el.classList.add('show');
                setTimeout(() => { el.classList.remove('show'); setTimeout(() => el.remove(), 300); }, duration);
            },
            async renderDashboard() {
                const [inv, logs, config] = await Promise.all([API.get('inventory'), API.get('history'), API.get('config')]);
                document.getElementById('stat-skus').innerText = inv.length;
                const totalVal = inv.reduce((sum, item) => sum + (item.price * item.units), 0);
                document.getElementById('stat-value').innerText = Utils.formatCurrency(totalVal);
                const lowStock = inv.filter(i => i.units < config.low_stock_threshold).length; 
                document.getElementById('stat-low').innerText = lowStock;
                const tbody = document.querySelector('#dashboard-recent-table tbody');
                tbody.innerHTML = logs.slice(0, 5).map(l => `<tr><td class="text-sm">${Utils.formatDate(l.timestamp)}</td><td>${l.user_email}</td><td>${l.action}</td><td>${l.details}</td></tr>`).join('');
            },
            async renderInventory() {
                const [inv, cats] = await Promise.all([API.get('inventory'), API.get('categories')]);
                const search = document.getElementById('inventory-search').value.toLowerCase();
                const catFilter = document.getElementById('inventory-cat-filter').value;
                const tbody = document.querySelector('#inventory-table tbody');
                const catSelect = document.getElementById('inventory-cat-filter');
                if (catSelect.options.length === 1) {
                    cats.forEach(c => {
                        const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name;
                        catSelect.appendChild(opt);
                    });
                }
                const modalCatSelect = document.getElementById('inv-category');
                modalCatSelect.innerHTML = '';
                cats.forEach(c => {
                    const opt = document.createElement('option'); opt.value = c.id; opt.innerText = c.name;
                    modalCatSelect.appendChild(opt);
                });
                const btnAdd = document.getElementById('btn-add-item');
                if (auth.canEdit('inventory')) btnAdd.classList.remove('hidden'); else btnAdd.classList.add('hidden');
                const filtered = inv.filter(i => {
                    const matchesSearch = i.sku.toLowerCase().includes(search) || i.name.toLowerCase().includes(search);
                    const matchesCat = catFilter === 'all' || i.category_id === catFilter;
                    return matchesSearch && matchesCat;
                });
                const getCategoryName = (id) => { const c = cats.find(x => x.id === id); return c ? c.name : 'Uncategorized'; };
                
                // Helper to calculate costs based on formulas
                tbody.innerHTML = filtered.map(item => {
                    const totalUnits = parseInt(item.units);
                    const unitsPerBox = parseInt(item.units_per_box);
                    const boxesPerCase = parseInt(item.boxes_per_case);
                    
                    // Stock breakdown
                    const boxes = Math.floor(totalUnits / unitsPerBox);
                    const remUnits = totalUnits % unitsPerBox;
                    const cases = Math.floor(boxes / boxesPerCase);
                    const remBoxes = boxes % boxesPerCase;

                    // COST CALCULATIONS
                    // Formula: Unit Cost = Unit Cost from DB (calculated as Invoice/Units)
                    const unitCost = parseFloat(item.unit_cost || 0);
                    
                    // Formula: Box Cost = Unit Cost * Units Per Box
                    const boxCost = unitCost * unitsPerBox;
                    
                    // Formula: Case Cost = Box Cost * Boxes Per Case
                    const caseCost = boxCost * boxesPerCase;

                    let actionButtons = '';
                    if (auth.user.role === 'Employee') {
                        actionButtons = `<button class="btn-sm btn-secondary" onclick="inventory.openStockModal('${item.id}')">Adjust Stock</button>`;
                    } else if (auth.user.role === 'Admin' || auth.user.role === 'SuperUser') {
                        actionButtons = `<button class="btn-sm btn-primary" onclick="inventory.openEditModal('${item.id}')">Edit</button><button class="btn-sm btn-danger" onclick="inventory.delete('${item.id}')">Delete</button>`;
                    }

                    return `<tr>
                        <td><span style="font-family: monospace; background: #eee; padding: 2px 4px; border-radius: 4px;">${item.sku}</span></td>
                        <td><span class="badge badge-employee">${getCategoryName(item.category_id)}</span></td>
                        <td>${item.name}</td>
                        <td class="desc-cell" title="${item.description || ''}">${item.description || '-'}</td>
                        <td>${Utils.formatCurrency(item.price)}</td>
                        <td class="text-sm"><span title="Cases">${cases}c</span> / <span title="Boxes">${remBoxes}b</span> / <span title="Units">${remUnits}u</span></td>
                        <td>${totalUnits}</td>
                        <td class="cost-cell">${Utils.formatCurrency(unitCost)}</td>
                        <td class="cost-cell">${Utils.formatCurrency(boxCost)}</td>
                        <td class="cost-cell">${Utils.formatCurrency(caseCost)}</td>
                        <td><div style="display: flex; gap: 5px;">${actionButtons}</div></td>
                    </tr>`;
                }).join('');
            },
            async renderCategories() {
                const [cats, inv] = await Promise.all([API.get('categories'), API.get('inventory')]);
                const tbody = document.querySelector('#categories-table tbody');
                tbody.innerHTML = cats.map(c => {
                    const count = inv.filter(i => i.category_id === c.id).length;
                    return `<tr><td>${c.id}</td><td>${c.name}</td><td>${count} items</td><td>${count === 0 ? `<button class="btn-sm btn-danger" onclick="categories.delete('${c.id}')">Delete</button>` : '<span class="text-muted text-sm">In Use</span>'}</td></tr>`;
                }).join('');
            },
            async renderConfig() {
                const conf = await API.get('config');
                document.getElementById('conf-sys-name').value = conf.system_name;
                document.getElementById('conf-low-stock').value = conf.low_stock_threshold;
                document.getElementById('conf-logo-url').value = conf.logo_url || '';
                document.getElementById('logo-preview').src = conf.logo_url || '';
                document.getElementById('conf-theme-color').value = conf.theme_color || '#512BD4';
            },
            async renderReports() {
                const [inv, cats, config] = await Promise.all([API.get('inventory'), API.get('categories'), API.get('config')]);
                const catValues = {};
                cats.forEach(c => catValues[c.id] = { name: c.name, val: 0 });
                inv.forEach(i => { if(catValues[i.category_id]) catValues[i.category_id].val += (i.price * i.units); });
                const maxVal = Math.max(...Object.values(catValues).map(x => x.val)) || 1;
                const chartContainer = document.getElementById('report-value-chart');
                chartContainer.innerHTML = Object.values(catValues).map(item => {
                    const pct = (item.val / maxVal) * 100;
                    return `<div class="bar-row"><div class="bar-label">${item.name}</div><div class="bar-track"><div class="bar-fill" style="width: ${pct}%">${Utils.formatCurrency(item.val)}</div></div></div>`;
                }).join('');
                const lowItems = inv.filter(i => i.units < config.low_stock_threshold);
                const lowBody = document.querySelector('#report-low-stock-table tbody');
                if (lowItems.length === 0) {
                    lowBody.innerHTML = '<tr><td colspan="4" style="text-align:center; color: green;">All stock healthy</td></tr>';
                } else {
                    lowBody.innerHTML = lowItems.map(i => `<tr><td>${i.sku}</td><td>${i.name}</td><td style="color: var(--danger); font-weight: bold;">${i.units}</td><td><span class="badge badge-admin">Low Stock</span></td></tr>`).join('');
                }
                document.getElementById('report-total-cats').innerText = cats.length;
                document.getElementById('report-total-skus').innerText = inv.length;
            },
            async renderHistory() {
                const logs = await API.get('history');
                const tbody = document.querySelector('#history-table tbody');
                tbody.innerHTML = logs.map(l => `<tr><td class="text-sm">${Utils.formatDate(l.timestamp)}</td><td>${l.user_email}</td><td><span class="badge badge-${l.user_role === 'Admin' ? 'admin' : (l.user_role === 'SuperUser' ? 'super' : 'employee')}">${l.user_role}</span></td><td>${l.action}</td><td class="text-sm text-muted">${l.details}</td></tr>`).join('');
            },
            async renderUsers() {
                const users = await API.get('users');
                const tbody = document.querySelector('#users-table tbody');
                tbody.innerHTML = users.map(u => `<tr><td>${u.email}</td><td><span class="badge badge-${u.role === 'Admin' ? 'admin' : (u.role === 'SuperUser' ? 'super' : 'employee')}">${u.role}</span></td><td class="text-sm">${Utils.formatDate(u.created_at)}</td><td>${u.id !== auth.user.id ? `<button class="btn-sm btn-danger" onclick="users.delete('${u.id}')">Delete</button>` : '<span class="text-muted text-sm">(Current)</span>'}</td></tr>`).join('');
            }
        };

        const inventory = {
            async openAddModal() {
                document.getElementById('inv-form').reset();
                document.getElementById('inv-id').value = '';
                document.getElementById('inv-modal-title').innerText = 'Inbound Receiving (Add New Item)';
                document.getElementById('modal-inventory').classList.add('open');
                await ui.renderInventory();
            },
            async openEditModal(id) {
                const inv = (await API.get('inventory')).find(i => i.id === id);
                if (!inv) return;
                await ui.renderInventory();
                document.getElementById('inv-id').value = inv.id;
                document.getElementById('inv-sku').value = inv.sku;
                document.getElementById('inv-category').value = inv.category_id;
                document.getElementById('inv-name').value = inv.name;
                document.getElementById('inv-price').value = inv.price;
                document.getElementById('inv-units').value = inv.units;
                document.getElementById('inv-description').value = inv.description || '';
                document.getElementById('inv-units-per-box').value = inv.units_per_box;
                document.getElementById('inv-boxes-per-case').value = inv.boxes_per_case;
                document.getElementById('inv-supplier').value = ''; // Clear inbound details on edit
                document.getElementById('inv-tracking').value = '';
                document.getElementById('inv-invoice-cost').value = '';
                document.getElementById('inv-modal-title').innerText = 'Edit Inventory Item';
                document.getElementById('modal-inventory').classList.add('open');
            },
            async save(e) {
                e.preventDefault();
                const id = document.getElementById('inv-id').value;
                const isNew = !id;
                const rawUnits = parseInt(document.getElementById('inv-units').value);
                const unitType = document.getElementById('inv-unit-type-rcv').value;
                const unitsPerBox = parseInt(document.getElementById('inv-units-per-box').value);
                const boxesPerCase = parseInt(document.getElementById('inv-boxes-per-case').value);
                let calculatedTotalUnits = rawUnits;
                if (unitType === 'Boxes') calculatedTotalUnits = rawUnits * unitsPerBox;
                else if (unitType === 'Cases') calculatedTotalUnits = rawUnits * unitsPerBox * boxesPerCase;
                
                const invoiceCost = parseFloat(document.getElementById('inv-invoice-cost').value) || 0;
                const unitCost = (invoiceCost > 0 && calculatedTotalUnits > 0) ? (invoiceCost / calculatedTotalUnits) : 0;
                
                const newItem = {
                    id: id || undefined,
                    sku: document.getElementById('inv-sku').value,
                    catId: document.getElementById('inv-category').value,
                    name: document.getElementById('inv-name').value,
                    description: document.getElementById('inv-description').value,
                    price: parseFloat(document.getElementById('inv-price').value),
                    units: calculatedTotalUnits,
                    unitsPerBox: unitsPerBox,
                    boxesPerCase: boxesPerCase,
                    invoiceCost: invoiceCost
                };

                await API.post('inventory', newItem);
                closeModals();
                await ui.renderInventory();
                ui.toast(isNew ? 'Item Received & Added' : 'Item Updated');
            },
            async delete(id) {
                if(!confirm('Are you sure?')) return;
                await API.delete(`inventory/${id}`);
                await ui.renderInventory();
                ui.toast('Item Deleted', 'error');
            },
            async openStockModal(id) {
                const item = (await API.get('inventory')).find(i => i.id === id);
                if(!item) return;
                document.getElementById('stock-form').reset();
                document.getElementById('stock-inv-id').value = item.id;
                document.getElementById('stock-item-name').innerText = item.name;
                document.getElementById('stock-current-units').innerText = item.units;
                document.getElementById('modal-stock').classList.add('open');
            },
            async adjustStock(e) {
                e.preventDefault();
                const id = document.getElementById('stock-inv-id').value;
                const amount = parseInt(document.getElementById('stock-amount').value);
                const item = (await API.get('inventory')).find(i => i.id === id);
                if(!item) return;
                const newTotal = item.units + amount;
                if (newTotal < 0) { ui.toast('Cannot reduce stock below 0', 'error'); return; }
                await API.put('inventory/stock', { id, units: newTotal });
                await API.post('history', { userEmail: auth.user.email, userRole: auth.user.role, action: 'Stock Adjust', details: `Stock adjust on ${item.sku}: ${amount > 0 ? '+' : ''}${amount}` });
                closeModals();
                await ui.renderInventory();
                ui.toast('Stock Adjusted');
            }
        };

        const categories = {
            openAddModal() { document.getElementById('cat-form').reset(); document.getElementById('modal-category').classList.add('open'); },
            async add(e) {
                e.preventDefault();
                const name = document.getElementById('cat-name').value;
                await API.post('categories', { name });
                closeModals();
                await ui.renderCategories();
                ui.toast('Category Added');
            },
            async delete(id) {
                if(!confirm('Delete this category?')) return;
                await API.delete(`categories/${id}`);
                await ui.renderCategories();
                ui.toast('Category Deleted');
            }
        };

        const config = {
            async save(e) {
                e.preventDefault();
                const systemName = document.getElementById('conf-sys-name').value;
                const lowStockThreshold = parseInt(document.getElementById('conf-low-stock').value);
                const logoUrl = document.getElementById('conf-logo-url').value;
                const themeColor = document.getElementById('conf-theme-color').value;
                
                await API.post('config', { systemName, lowStockThreshold, logoUrl, themeColor });
                router.applyBranding({ system_name: systemName, logo_url: logoUrl, theme_color: themeColor });
                ui.toast('Configuration Saved');
            }
        };

        const users = {
            openAddModal() { document.getElementById('user-form').reset(); document.getElementById('modal-user').classList.add('open'); },
            async add(e) {
                e.preventDefault();
                const email = document.getElementById('user-email').value;
                const pass = document.getElementById('user-pass').value;
                const role = document.getElementById('user-role').value;
                await API.post('users', { email, password: pass, role });
                closeModals();
                await ui.renderUsers();
                ui.toast('User Added');
            },
            async delete(id) {
                if(!confirm('Delete user?')) return;
                await API.delete(`users/${id}`);
                await ui.renderUsers();
                ui.toast('User Deleted');
            }
        };

        // Event Listeners
        document.getElementById('conf-logo-url').addEventListener('input', (e) => { document.getElementById('logo-preview').src = e.target.value; });
        document.getElementById('conf-theme-color').addEventListener('input', (e) => {
            const color = e.target.value;
            const dark = Utils.darkenColor(color, 20);
            document.documentElement.style.setProperty('--primary', color);
            document.documentElement.style.setProperty('--primary-dark', dark);
        });
        document.getElementById('btn-save-config').addEventListener('click', config.save);

        function closeModals() { document.querySelectorAll('.modal-overlay').forEach(el => el.classList.remove('open')); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pass = document.getElementById('login-password').value;
            await auth.login(email, pass);
        });

        document.getElementById('otp-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const code = document.getElementById('otp-code').value;
            if (await auth.verifyOtp(code)) {
                router.showApp();
                ui.toast(`Welcome back, ${auth.user.role}`);
            } else {
                ui.toast('Invalid or expired code', 'error');
            }
        });

        document.getElementById('inv-form').addEventListener('submit', inventory.save);
        document.getElementById('stock-form').addEventListener('submit', inventory.adjustStock);
        document.getElementById('cat-form').addEventListener('submit', categories.add);
        document.getElementById('user-form').addEventListener('submit', users.add);
        document.getElementById('inventory-search').addEventListener('input', ui.renderInventory);
        document.getElementById('inventory-cat-filter').addEventListener('change', ui.renderInventory);
        window.addEventListener('load', router.init);
    </script>
</body>
</html>